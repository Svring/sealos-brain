---
title: å‡½æ•°è°ƒç”¨å±‚çº§
description: "APIå‡½æ•°ã€åŠŸèƒ½å‡½æ•°ã€AIå·¥å…·ã€Query/Mutationå‡½æ•°ã€Hooks"
---

é¡¹ç›®ä¸­çš„å‡½æ•°å¯ä»¥æŒ‰å°è£…ç¨‹åº¦è¿›è¡Œåˆ†å±‚ï¼Œå°è£…ç¨‹åº¦è¶Šé«˜ï¼Œå±‚çº§è¶Šé«˜ï¼Œä¾èµ–è¶Šå¤šã€‚

![1-hierarchy.png](/docs/å‡½æ•°è°ƒç”¨å±‚çº§/1-hierarchy.png)

æ‰€æœ‰APIè°ƒç”¨å‡½æ•°ä¼šå…ˆå°è£…ä¸ºåŠŸèƒ½å‡½æ•°ä»¥é€‚åº”Brainçš„åŠŸèƒ½éœ€æ±‚ï¼ŒåŠŸèƒ½å‡½æ•°å†å‘ä¸Šåˆ†åˆ«å°è£…ä¸ºå‰ç«¯ä¸“ç”¨çš„Hookså’ŒAIä¸“ç”¨çš„AIå·¥å…·ã€‚
## APIå‡½æ•°

### çº¯å‡½æ•°
APIå‡½æ•°ä¼šå°è£…Sealosæ¡Œé¢/Kubernetesçš„å®˜æ–¹APIï¼Œè´Ÿè´£å‘èµ·è¯·æ±‚ã€è§£æå“åº”å¹¶å¤„ç†æŠ¥é”™ï¼Œä»¥Devboxä¸ºä¾‹ã€‚
```tsx
export const getDevboxTemplates = async (context: K8sContext) => {
	const api = await createDevboxAxios(context, "v1/devbox"); // æ„å»ºè¯·æ±‚åœ°å€å’Œè¯·æ±‚å¤´
	const response = await api.get("/templates"); // å‘é€è¯·æ±‚ã€æ¥æ”¶å“åº”
	return response.data.data; // è¿”å›å“åº”
};
```

APIå‡½æ•°çš„å†…éƒ¨å®ç°é€šå¸¸å¾ˆç®€çŸ­ï¼Œä¹Ÿå°±æ˜¯ä¸Šå›¾æ‰€ç¤ºçš„æ„å»ºè¯·æ±‚ã€å‘é€è¯·æ±‚ã€è¿”å›å“åº”ä¸‰æ­¥ï¼ŒAPIå‡½æ•°ä¸åº”è¯¥åŒ…å«è¿™ä¸‰æ­¥ä»¥å¤–çš„å‰¯ä½œç”¨ï¼Œæ¯”å¦‚`console.log`æŠ¥é”™ä¿¡æ¯ã€è¿›è¡Œè¯·æ±‚å‚æ•°æˆ–è¿”å›å“åº”è½¬æ¢ç­‰ï¼Œä¹Ÿå°±æ˜¯æ¥è¿‘â€œ[çº¯å‡½æ•°](https://zh-hans.react.dev/learn/keeping-components-pure)â€çš„å®šä¹‰ï¼Œä¸åŒ…å«é™¤â€œå‘é€ç½‘ç»œè¯·æ±‚â€ä¹‹å¤–çš„ä»»ä½•å‰¯ä½œç”¨ï¼Œæ‰€ä»¥ä¸èƒ½å‡ºç°`console.log`.

é¿å…â€œè¿›è¡Œè¯·æ±‚å‚æ•°æˆ–è¿”å›å“åº”è½¬æ¢â€æ„å‘³ç€APIå‡½æ•°åœ¨å£°æ˜è‡ªå·±çš„å‚æ•°å’Œè¿”å›å€¼æ—¶éœ€è¦ä¸¥æ ¼å‚ç…§ç›®æ ‡APIæ¥å£çš„Openapiå®šä¹‰ï¼Œå‚è€ƒä¸‹é¢è¿™ä¸ªé”™è¯¯å®ç°çš„APIå‡½æ•°:

```tsx
export const authCname = async (
	context: K8sContext,
	publicDomain: string,
	customDomain: string,
) => {
	const api = await createDevboxAxios(context);
	const cleanPublicDomain = publicDomain?.replace(/^https?:\/\//, "") || "";
	const response = await api.post("/platform/authCname", {
		publicDomain: cleanPublicDomain, // cleanPublicDomainä¸æ¥å£çš„å‚æ•°åpublicDomainä¸åŒ¹é…
		customDomain,
	});
	return response.data;
};
```
publicDomainå’ŒcustomDomainç¡®å®æ˜¯ç›®æ ‡æ¥å£éœ€è¦çš„æ•°æ®åç§°ï¼Œä½†è¿™ä¸ªå‡½æ•°åœ¨ä¼ é€’å‚æ•°å‰å°†publicDomainè½¬æ¢ä¸ºäº†cleanPublicDomainï¼Œè¿åäº†APIå‡½æ•°çš„å¼€å‘åŸåˆ™ã€‚

æ€»ç»“ï¼š**APIå‡½æ•°çš„å”¯ä¸€ä½œç”¨æ˜¯å°†å‚æ•°å‘é€åˆ°ç›®æ ‡APIæ¥å£ï¼Œå¹¶è¿”å›å“åº”ã€‚**

### å‚æ•°è®¾è®¡
åœ¨ä¿æŒå‡½æ•°ä½“çº¯ç²¹çš„å‰æä¸‹ï¼ŒAPIå‡½æ•°è¿˜åº”è¯¥ç¡®ä¿å‚æ•°åŒ…å«ä¸¤ä¸ªå­—æ®µï¼šcontextå’Œparamsï¼Œcontextæä¾›åŸŸåã€å¯†é’¥ç­‰é™„åŠ ä¿¡æ¯ï¼Œparamsæä¾›è·¯å¾„ã€bodyç­‰è¯·æ±‚å‚æ•°ï¼Œå‚è€ƒä¸‹é¢è¿™ä¸ªå‡æƒ³å‡½æ•°ï¼š
```tsx
interface Context {
  regionalUrl: string;
  token: string;
}

interface Parameters {
  path: {
    name: string;
    operation: string;
  };
  search: {
    queryKey: string;
  };
  body: Record<string, any>;
}

async function ohMyBrain(context: Context, parameters: Parameters): Promise<any> {
  const baseURL = `${context.regionalUrl}/api`; // é€šè¿‡regionalUrlç¡®å®šå¯ç”¨åŒºåœ°å€
  
  const httpsAgent = new https.Agent({
    keepAlive: true,
  });

  const api = axios.create({
    baseURL,
    headers: {
      "Content-Type": "application/json",
      Authorization: `Bearer ${context.token}`, // tokenå¡«å…¥header
    },
    httpsAgent,
  });

	// æ·»åŠ è·¯å¾„å‚æ•°
  const response = await api.get(`/${parameters.path.name}/${parameters.path.operation}`, {
    params: parameters.search, // æ·»åŠ æŸ¥è¯¢å‚æ•°
    data: parameters.body, // æ·»åŠ bodyå‚æ•°
  });

  return response.data;
}
```

è¿™ä¸ªå‡æƒ³å‡½æ•°æ˜¯APIå‡½æ•°æœ€å¤æ‚çš„å½¢å¼ï¼ŒåŒæ—¶åŒ…å«è·¯å¾„ã€æŸ¥è¯¢ã€bodyä¸‰ç§å‚æ•°ï¼Œå®é™…é¡¹ç›®é‡Œçš„APIå‡½æ•°éƒ½å±äºå®ƒçš„å­é›†ï¼Œæ¯”å¦‚ä¸‹é¢è¿™ä¸ªå‡½æ•°ï¼š

```tsx title="APIå‡½æ•°ï¼šéƒ¨ç½²Devbox"
export const deployDevbox = async (
	context: K8sContext,
	devboxName: string, // ä¸è§„èŒƒï¼ŒdevboxNameå’Œtagåº”è¯¥åŒ…å«åœ¨ä¸€ä¸ªparameterså¯¹è±¡ä¸­
	tag: string,
) => {
	const api = await createDevboxAxios(context, "v1/devbox");
	const response = await api.post(`/${devboxName}/release/${tag}/deploy`, {}); // ä¼ å…¥devboxNameå’Œtagä¸¤ä¸ªè·¯å¾„å‚æ•°
	return response.data;
};
```

## åŠŸèƒ½å‡½æ•°
### AIå¯è¯»
æœ‰æ—¶APIå‡½æ•°ä»æ¥å£æ‹¿åˆ°çš„æ•°æ®éœ€è¦è¿›ä¸€æ­¥å¤„ç†ä»¥ç¬¦åˆå‰ç«¯hookå’ŒAIå·¥å…·çš„è¦æ±‚ï¼Œæœ‰æ—¶å‰ç«¯hookéœ€è¦çš„æ•°æ®APIå¹¶æ²¡æœ‰æä¾›ï¼ŒåŠŸèƒ½å‡½æ•°è´Ÿè´£è¡¥å…¨è¿™äº›å†…å®¹ã€‚

å‰ç«¯å’ŒAIå…±ç”¨ä¸€å±‚åŠŸèƒ½å‡½æ•°æ„å‘³ç€ä¸€ä¸ªåŠŸèƒ½å¦‚æœå¯¹å‰ç«¯å¼€æ”¾ï¼Œé‚£ä¹ˆå®ƒå¯¹AIä¹Ÿå¼€æ”¾ï¼Œä¸ºäº†æœ€å¤§ç¨‹åº¦ç¡®ä¿å¯å¤ç”¨æ€§ï¼ŒåŠŸèƒ½å‡½æ•°åœ¨è®¾è®¡æ—¶éœ€è¦ä¸¤ç§ç”¨æ³•éƒ½è€ƒè™‘ã€‚

ä¸¾ä¾‹æ¥è¯´ï¼Œå¦‚æœå‰ç«¯ç°åœ¨éœ€è¦è·å¾—devboxç«¯èµ„æºå ç”¨ç‡ä¿¡æ¯æ¥ç»˜åˆ¶å›¾è¡¨ï¼Œé‚£ä¹ˆå‡è®¾æ—¶é—´è½´å›ºå®šä¸ºä¸€å°æ—¶ï¼Œæ•°æ®é—´éš”ä¸ºä¸¤åˆ†é’Ÿï¼Œé‚£ä¹ˆå‰ç«¯ç»˜åˆ¶å›¾è¡¨æ—¶å¯ä»¥ç”¨è¿™æ®µæ•°æ®ï¼š

```
cpu: [0.08, 0.02, 0.13...]
```

0.08ä¼šå‡ºç°åœ¨å›¾è¡¨æœ€å·¦ä¾§ï¼Œä»£è¡¨ä¸€å°æ—¶å‰cpuå ç”¨ç‡ä¸º8%ï¼Œè€Œ0.02ä»£è¡¨58åˆ†é’Ÿå‰cpuå ç”¨ç‡ä¸º2%ï¼Œåªè¦uiç»„ä»¶çš„é¢„è®¾å€¼æ­£ç¡®ï¼Œç¨‹åºå°±å¯ä»¥è¯»æ‡‚è¿™æ®µæ•°æ®å¹¶æ­£ç¡®ç»˜åˆ¶å›¾è¡¨ã€‚

ä½†å¦‚æœè¿™æ®µæ•°æ®å·¥å…·æ˜¯è¿”å›ç»™AIçš„ç»“æœï¼Œé‚£ä¹ˆAIæ˜¯æ²¡æ³•è¯»æ‡‚[0.08, 0.02, 0.13...]è¿™ä¸²æ•°æ®å¯¹åº”çš„æ—¶é—´èŠ‚ç‚¹çš„ï¼Œåœ¨æç¤ºè¯é‡Œå£°æ˜â€œæ—¶é—´è½´å›ºå®šä¸ºä¸€å°æ—¶ï¼Œæ•°æ®é—´éš”ä¸ºä¸¤åˆ†é’Ÿâ€ä¹Ÿæ²¡ç”¨ï¼Œå› ä¸ºAIå¹¶ä¸çŸ¥é“å½“å‰çš„æ—¶é—´ï¼Œå³ä½¿çŸ¥é“ï¼Œè®©AIè‡ªå·±é€šè¿‡ç´¢å¼•è®¡ç®—æ—¶é—´èŠ‚ç‚¹ä¹Ÿä¼šå½±å“å›å¤æ—¶çš„å‡†ç¡®ç‡ã€‚

å› æ­¤ï¼Œè¿™ä¸ªåŠŸèƒ½å‡½æ•°åœ¨è®¾è®¡æ—¶å°±åº”è¯¥å°†è¿”å›å€¼è®¾å®šä¸ºï¼š
```json title="å‰ç«¯å¯è¯»æ•°æ®"
cpu: [
  {
    "timestamp": 1760510280, // ç¨‹åºå¯è¯»çš„æ—¶é—´æˆ³
    "readableTime": "2025/10/15 14:38", // AIå¯è¯»çš„æ—¶é—´æˆ³
    "cpu": 1.08, // ç›´æ¥ä»¥%ä¸ºå•ä½
    "memory": 10.32 // å†…å­˜ç”¨é‡å’Œcpuä¸€èµ·è¿”å›ï¼Œä»¥ä¾¿äºAIé€šè¿‡ä¸€æ¬¡å·¥å…·è°ƒç”¨è·å–æ‰€æœ‰æ•°æ®
  },
  {
    "timestamp": 1760510340,
    "readableTime": "2025/10/15 14:39",
    "cpu": 1.18,
    "memory": 10.37
  }
]
```
æ€»ç»“ï¼š**æ‰€æœ‰åŠŸèƒ½å‡½æ•°çš„å‚æ•°å’Œè¿”å›å€¼ä¸ä»…è¦ç¨‹åºå¯è¯»ï¼Œè¿˜è¦AIå¯è¯»ã€‚**
> AIå¯è¯»çš„å‡½æ•°ï¼Œå¯¹ç¨‹åºæ¥è¯´ä¹Ÿæ›´æ˜“å¤„ç†ã€‚

## å¯¹APIåŠŸèƒ½çš„æ‰©å±•
ä¸¾ä¾‹æ¥è¯´ï¼ŒDevboxæ—§APIçš„èµ„æºå ç”¨ç‡æ¥å£æ¯æ¬¡åªèƒ½æŸ¥è¯¢cpu/memoryå…¶ä¸­ä¸€ä¸ªï¼Œæ‰€ä»¥åŒæ—¶ç»˜åˆ¶cpuå’Œmemoryå›¾è¡¨æ—¶éœ€è¦è°ƒç”¨ä¸¤æ¬¡æ¥å£ï¼Œå¯¹äºAIå·¥å…·ä¸å‹å¥½ï¼ŒBrainä¸ºæ­¤æ·»åŠ äº†ä¸€ä¸ªåŠŸèƒ½å‡½æ•°ä»¥ä¾¿äºåŒæ—¶è¯·æ±‚æ‰€æœ‰èµ„æºç±»å‹å¹¶è½¬æ¢æ•°æ®ï¼š
```tsx
export const getDevboxMonitor = async (
	context: K8sContext,
	target: CustomResourceTarget,
) => {
	const [cpuResult, memoryResult] = await Promise.allSettled([
		getDevboxMonitorData(context, "average_cpu", target.name),
		getDevboxMonitorData(context, "average_memory", target.name),
	]);

	const cpuData =
		cpuResult.status === "fulfilled" ? cpuResult.value : undefined;
	const memoryData =
		memoryResult.status === "fulfilled" ? memoryResult.value : undefined;

	// Transform combined monitor data
	const monitorData: MonitorData = {
		cpu: cpuData ? { data: cpuData } : undefined,
		memory: memoryData ? { data: memoryData } : undefined,
	};

	return transformMonitorData(monitorData);
};
```
æ‰©å±•APIè¿™é‡Œæ²¡æœ‰ä»€ä¹ˆè®¾è®¡è¦ç‚¹ï¼Œéšæœºåº”å˜å°±è¡Œï¼Œåªæ˜¯è®°å¾—å°½é‡æŠŠåŠŸèƒ½é›†æˆåˆ°APIé‡Œã€‚

## AIå·¥å…·
AIå·¥å…·å±‚çš„å°è£…æ˜¯é’ˆå¯¹è¯­è¨€æ¨¡å‹å’ŒAIæ¡†æ¶ï¼ˆLanggraphï¼‰çš„ç‰¹åˆ«ä¼˜åŒ–ï¼Œä¸å¸¸è§„çš„å‰ç«¯å‡½æ•°å°è£…ç›¸æ¯”ï¼ŒAIå·¥å…·æœ‰ä»¥ä¸‹å‡ ä¸ªç‰¹å¾ï¼š
1. AIè°ƒç”¨å‡½æ•°çš„è¿‡ç¨‹å¯ä»¥æ˜¯è¿ç»­çš„ï¼Œä¹Ÿå¯ä»¥æ˜¯ä¸­æ–­çš„ï¼›
2. AIè°ƒç”¨å‡½æ•°æ—¶éœ€è¦è‡ªè¡Œç”Ÿæˆé™¤contextï¼ˆè¯·æ±‚åœ°å€ã€é‰´æƒä¿¡æ¯ï¼‰ä»¥å¤–çš„å‚æ•°ï¼›
3. AIå·¥å…·éœ€è¦æœ‰ååˆ†æ˜ç¡®çš„ä½¿ç”¨è¯´æ˜ï¼›

è¿™ä¸‰ä¸ªç‰¹å¾çš„å¸¦æ¥çš„é—®é¢˜å’Œå¯èƒ½æ€§éƒ½å¾ˆå¤šï¼Œä¸‹é¢ä¼šé€ä¸ªè§£é‡Šã€‚

### ä¸­æ–­
ä¸€ä¸ªå¸¸è§„çš„å‡½æ•°è°ƒç”¨è¿‡ç¨‹çœ‹èµ·æ¥åƒä¸‹é¢è¿™æ ·ï¼Œå‘ä¸€ä¸ªå‡½æ•°è¾“å…¥å‚æ•°ï¼Œå‡½æ•°ä¼šæ‰§è¡Œæ—¢å®šçš„æ­¥éª¤å¹¶è¾“å‡ºç»“æœã€‚

![2-normal-call](/docs/å‡½æ•°è°ƒç”¨å±‚çº§/2-normal-call.png)

AIåœ¨è¿ç»­è°ƒç”¨å‡½æ•°æ—¶ä¹Ÿæ˜¯åŒæ ·çš„æµç¨‹ï¼Œä½†AIå·¥å…·å­˜åœ¨â€œäººå·¥ä»‹å…¥(Human-In-The-Loop)â€çš„æ¦‚å¿µï¼Œé€šè¿‡äººä¸ºå®¡æŸ¥/ä¿®æ”¹AIæä¾›çš„å‚æ•°æ¥å‡è½»AIå‡ºé”™çš„å½±å“ï¼ŒLanggraphä¸­å®ç°è¿™ä¸€æ¦‚å¿µçš„æœºåˆ¶å«åšâ€œ[ä¸­æ–­](https://docs.langchain.com/oss/javascript/langgraph/interrupts)â€ã€‚

ä¸­æ–­çš„æ—¶é—´ç‚¹å¹¶ä¸æ˜¯å›ºå®šçš„ï¼ŒLanggraphå…è®¸åœ¨ä»»æ„ä¸€è¡Œä»£ç é‡Œæ’å…¥ä¸­æ–­ç‚¹å¹¶è®¾ç½®ç‰¹å®šçš„æ¢å¤æ¡ä»¶ï¼ˆæ¯”å¦‚è·å¾—ç”¨æˆ·çš„"å‡†è®¸æ‰§è¡Œ"æŒ‡ä»¤ï¼Œè¡¨ç°å½¢å¼å¯èƒ½æ˜¯ä¸€æ®µjsonæ•°æ®`{ user_approved: true }`ï¼‰è®¾ç½®å¥½ä¸­æ–­ç‚¹åï¼Œç¨‹åºä¼šåœ¨è¿è¡Œåˆ°ä¸­æ–­ç‚¹æ—¶æš‚åœæ‰§è¡Œï¼Œå¹¿æ’­ç¨‹åºå½“å‰çš„çŠ¶æ€ï¼Œå¹¶ç­‰å¾…ç”¨æˆ·ä¼ å…¥æ–°çš„æ•°æ®ï¼Œå¯ä»¥ç±»æ¯”ä¸€ä¸‹Vscodeä¸­Debugæ–­ç‚¹çš„æ¦‚å¿µï¼Œç¨‹åºæ‰§è¡Œ -> åˆ°è¾¾æ–­ç‚¹ -> æš‚åœæ‰§è¡Œï¼Œåœ¨é¢æ¿ä¸­å±•ç¤ºæ‰€æœ‰å˜é‡ä¿¡æ¯ -> å¾—åˆ°"ç»§ç»­æ‰§è¡Œ"æˆ–"ç»ˆæ­¢æ‰§è¡Œ"çš„æŒ‡ä»¤ã€‚åŒºåˆ«åœ¨äºLanggraphä¸­æ–­ç‚¹å…è®¸å‘ç¨‹åºä¸­æ’å…¥æ–°æ•°æ®ï¼Œæ¯”å¦‚å‰é¢æåˆ°çš„`{ user_approved: true }`ï¼Œè€ŒDebugæ–­ç‚¹åªæ˜¯å±•ç¤ºç¨‹åºåœ¨ç‰¹å®šæ—¶åˆ»çš„çŠ¶æ€ï¼Œä½†ä¸å…è®¸ä¿®æ”¹ç¨‹åºçŠ¶æ€ã€‚

![3-interrupt-call](/docs/å‡½æ•°è°ƒç”¨å±‚çº§/3-interrupt-call.png)

å¦‚å›¾ï¼Œå‡å®šåŠŸèƒ½å‡½æ•°æœ‰å››è¡Œä»£ç ï¼Œä¸­æ–­ç‚¹æ”¾åœ¨ç¬¬äºŒå’Œç¬¬ä¸‰è¡Œä»£ç ä¹‹é—´ï¼Œé‚£ä¹ˆå½“ç¨‹åºæ‰§è¡Œå®Œç¬¬äºŒè¡Œä»£ç åå°±ä¼šä¸­æ–­ï¼Œå¹¶å¹¿æ’­*ä»»æ„ä¿¡æ¯*ï¼Œäººå·¥ä»‹å…¥æ—¶å¯ä»¥ä¿®æ”¹è¿™æ®µä¿¡æ¯ä¸º*ä»»æ„ç»“æ„*ï¼Œç¨‹åºæ¢å¤æ—¶ä¼šæ ¹æ®ç”¨æˆ·ä¿®æ”¹åçš„çŠ¶æ€æ‰§è¡Œåç»­é€»è¾‘ã€‚
çº¯æ–‡å­—çœ‹èµ·æ¥è¿˜æ˜¯å¤ªæŠ½è±¡äº†ï¼Œä¸‹é¢æ˜¯Langgraphå®˜ç½‘é‡ŒInterruptçš„ç¤ºä¾‹ï¼š

```tsx title="åŒ…å«ä¸­æ–­ç‚¹çš„ç¨‹åº"
import { interrupt, Command } from "@langchain/langgraph";

function approvalNode(state: State): Command {
  // Pause execution; payload surfaces in result.__interrupt__
  const isApproved = interrupt({
    question: "Do you want to proceed?",
    details: state.actionDetails
  }); // ä¸­æ–­ï¼ŒinterruptåŒ…å«çš„æ•°æ®å°±æ˜¯ä¼šè¢«å¹¿æ’­å‡ºå»çš„æ•°æ®

  // Route based on the response
  if (isApproved) {
    return new Command({ goto: "proceed" }); // Runs after the resume payload is provided
  } else {
    return new Command({ goto: "cancel" });
  }
}
```

åŒ…å«ä¸­æ–­ç‚¹çš„ç¨‹åºè¦å°†éœ€è¦å¹¿æ’­çš„æ•°æ®ä¼ å…¥*interrupt*å‡½æ•°ä¸­ï¼Œä¼ å…¥çš„æ•°æ®å°±æ˜¯å¯ä»¥è¢«å®¢æˆ·ç«¯è¯»åˆ°çš„æ•°æ®ï¼Œä¹Ÿå°±æ˜¯è¯´è¿™ä¸ªç¨‹åºä¸­æ–­åï¼Œå®¢æˆ·ç«¯å¯ä»¥çœ‹åˆ°â€œç¨‹åºä¸­æ–­â€çš„çŠ¶æ€å’Œä»¥ä¸‹æ•°æ®ï¼š

```tsx title="ä¸­æ–­ä¿¡æ¯"
{
	question: "Do you want to proceed?",
	details: state.actionDetails
}
```

Langgraphåˆ†ä¸ºæœåŠ¡ç«¯å’Œå®¢æˆ·ç«¯ï¼ŒæœåŠ¡ç«¯è´Ÿè´£åˆ¶å®šAIè¿è¡Œçš„é€»è¾‘ï¼ˆä¸­æ–­ç‚¹ã€æ¨¡å‹è°ƒç”¨ï¼‰å®¢æˆ·ç«¯è´Ÿè´£å‘é€è¯·æ±‚ï¼ˆä¼ å…¥ç”¨æˆ·è¯·æ±‚ã€æ¢å¤ä¸­æ–­ï¼‰å¯ä»¥ç±»æ¯”Openapiçš„åç«¯æ¥å£å’Œå‰ç«¯è°ƒç”¨å‡½æ•°ã€‚

```tsx title="æ¢å¤ä¸­æ–­ç‚¹çš„ç¨‹åº"
// To approve
await graph.invoke(new Command({ resume: true }), config);

// To reject
await graph.invoke(new Command({ resume: false }), config);
```

æ¢å¤ä¸­æ–­ç‚¹çš„å‡½æ•°å¯ä»¥è¯»å–ä¸­æ–­ä¿¡æ¯å¹¶ä¼ å…¥`Command({ resume: true })`ä½œä¸ºæ¢å¤æ‰§è¡Œçš„ä¿¡å·ï¼Œresumeä¸­çš„æ•°æ®å°±æ˜¯è¢«ä¼ å…¥ç¨‹åºçš„æ–°æ•°æ®ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼š

```tsx title="ä¸­æ–­å‰åçš„çŠ¶æ€å˜åŒ–"
// ä¸­æ–­å‰çš„çŠ¶æ€ï¼ŒisApprovedæ˜¯ä¸­æ–­ç‚¹ï¼Œç¨‹åºæ‰§è¡Œåˆ°è¿™é‡Œåä¼šä¸­æ–­
const isApproved = interrupt({
	question: "Do you want to proceed?",
	details: state.actionDetails
});

// ä¸­æ–­å¹¶æ”¶åˆ°æŒ‡ä»¤new Command({ resume: true })åçš„çŠ¶æ€ï¼Œæ•´ä¸ªinterruptå‡½æ•°è¢«æ›¿æ¢æˆäº†resumeæŒ‡ä»¤çš„å€¼'true'ï¼Œå¹¶èµ‹å€¼ç»™å˜é‡'isApproved'ï¼Œè¿™ä¸€å˜é‡ä¼šç”¨äºåç»­æ‰§è¡Œä¸­ã€‚
const isApproved = true

// æ­¤æ—¶isApprovedä¸ºtrueï¼Œè¿›å…¥ç¬¬ä¸€ä¸ªä»£ç å—
if (isApproved) {
	return new Command({ goto: "proceed" }); // Runs after the resume payload is provided
} else {
	return new Command({ goto: "cancel" });
}
```

Commandæ˜¯Langgraphçš„å¦ä¸€ä¸ªç‰¹æ®Šæœºåˆ¶ï¼Œå’ŒLanggraphèŠ‚ç‚¹å›¾çš„æ¶æ„å¼ºç›¸å…³ï¼Œä¸åªå±€é™äºä¸­æ–­æ¢å¤çš„åŠŸèƒ½ï¼Œæœ‰å…³Commandçš„æ–‡æ¡£åŒæ ·åœ¨[Interrupt](https://docs.langchain.com/oss/javascript/langgraph/interrupts)é‡Œï¼Œä¹Ÿå¯ä»¥çœ‹ä¸‹[è¿™ä¸€æ®µ](https://docs.langchain.com/oss/javascript/langgraph/graph-api#command)ä»‹ç»äº†æ€ä¹ˆç”¨Commandè·³è½¬èŠ‚ç‚¹å’Œæ›´æ–°çŠ¶æ€ï¼Œè¿™ä¸ªåŠŸèƒ½åœ¨Brainé‡Œä¹Ÿæ˜¯å¤§èŒƒå›´ä½¿ç”¨çš„ã€‚

å…¶å®ä¸Šå›¾çš„ä¸­æ–­æ¢å¤ä»£ç æ˜¯ä¸ºäº†æ–¹ä¾¿æ¼”ç¤ºï¼Œå’Œå®é™…é¡¹ç›®é‡Œçš„ä»£ç æœ‰ä¸å°‘å·®å¼‚ï¼Œè¿™éƒ¨åˆ†å·®å¼‚ä¼šåœ¨å¼€å‘æ¨¡å¼ç›®å½•ä¸‹çš„æ–‡æ¡£é‡Œè¯´æ˜ã€‚
å¦å¤–ï¼Œä¸­æ–­ä¹Ÿæ˜¯AGUIçš„æ ¸å¿ƒæœºåˆ¶ï¼Œä¸€ä¸ªç¨‹åºåœ¨ä¸­æ–­å‰ã€ä¸­æ–­æ—¶ã€æ¢å¤åéƒ½å¯èƒ½éœ€è¦å±•ç¤ºç‰¹å®šçš„AGUIï¼ŒBrainä¸­"åˆ›å»ºæ•°æ®åº“"è¿™ä¸ªAIå·¥å…·å°±æœ‰ä¸¤ä¸ªAGUIåˆ†åˆ«ç”¨äºå±•ç¤ºä¸­æ–­æ•°æ®å’Œæ‰§è¡Œç»“æœï¼Œæ‰§è¡Œç»“æœåˆä¼šåˆ†ä¸ºæˆåŠŸ/å¤±è´¥/æ‹’ç»æ‰§è¡Œè¿™å‡ ç§å¯èƒ½ï¼Œbut fret notï¼ŒAGUIä¼šæœ‰ä¸“é—¨çš„è®¾è®¡æ¨¡å¼å’Œå¼€å‘æ¨¡å¼æ–‡æ¡£ã€‚

### AIç”Ÿæˆå‚æ•°
#### å‚æ•°ç»“æ„
AIï¼ˆè¯­è¨€æ¨¡å‹ï¼‰çš„è¾“å‡ºæ˜¯çº¯æ–‡æœ¬ï¼Œè¶Šé•¿çš„æ–‡æœ¬è¾“å‡ºæ—¶é—´è¶Šé•¿ï¼Œç»“æ„è¶Šå¤æ‚çš„æ–‡æœ¬å‡ºé”™ç‡è¶Šé«˜ï¼Œå› æ­¤AIå·¥å…·çš„å‚æ•°éœ€è¦å°½å¯èƒ½ç®€åŒ–ï¼Œé™¤æ­¤ä¹‹å¤–ï¼ŒAIå·¥å…·çš„å‚æ•°è®¾è®¡å’ŒåŠŸèƒ½å‡½æ•°ååˆ†ç›¸ä¼¼ï¼Œéƒ½æ¥æ”¶contextå’Œparameterså‚æ•°ï¼Œåªæ˜¯å®ç°ç»†èŠ‚éœ€è¦æ ¹æ®AIæ¡†æ¶(Langgraph)åšè°ƒæ•´ã€‚

å¯ä»¥è€ƒè™‘å…ˆçœ‹çœ‹Langgraphå®˜ç½‘æ–‡æ¡£ä¸­çš„[æ€ç»´æ¨¡å‹](https://docs.langchain.com/oss/javascript/langgraph/thinking-in-langgraph)ä»‹ç»ã€‚

Langgraphä¸­çš„contextè¢«å‘½åä¸ºStateï¼Œå½¢å¼è¡¨ç°ä¸ºä¸€ä¸ªzod schema:

```tsx
import * as z from "zod";

// Define the structure for email classification
const EmailClassificationSchema = z.object({
  intent: z.enum(["question", "bug", "billing", "feature", "complex"]),
  urgency: z.enum(["low", "medium", "high", "critical"]),
  topic: z.string(),
  summary: z.string(),
});
```

Stateæ˜¯æ‰€æœ‰LanggraphèŠ‚ç‚¹çš„å…±æœ‰contextï¼ŒAIå·¥å…·åªèƒ½ä»Stateé‡Œè·å–contextä¿¡æ¯ï¼Œè€Œä¸èƒ½åƒAPIå‡½æ•°é‚£æ ·ä»å‚æ•°é‡Œç›´æ¥ä¼ å…¥ï¼ˆå› ä¸ºAIå·¥å…·çš„å‚æ•°åªèƒ½ç”±AIä¼ å…¥ï¼‰ï¼Œä¸¾ä¾‹æ¥è¯´ï¼Œå‡è®¾ç°åœ¨æœ‰ä¸¤ä¸ªå‚æ•°è®¾è®¡ç›¸åŒçš„APIå‡½æ•°å’ŒAIå·¥å…·ï¼š

```tsx title="APIå‡½æ•°"
const welcome = (context, parameters): { context: any, parameters: any} => {
	return `Welcome the user to the new agent. \n\n 
		Joke: ${parameters.joke} \n\n 
		State: ${JSON.stringify(context)}`;
}
```
```tsx title="AIå·¥å…·"
import { getCurrentTaskInput } from "@langchain/langgraph";
import { tool } from "langchain";
import * as z from "zod";

const welcome = tool(
	({ joke }) => {
		const state = getCurrentTaskInput();
		return `Welcome the user to the new agent. \n\n 
			Joke: ${joke} \n\n 
			State: ${JSON.stringify(state)}`;
	},
	{
		name: "welcome",
		description: "Welcome the user with a joke.",
		schema: z.object({
			joke: z.string().describe("The joke to welcome the user with"),
		}),
	},
);
```

åœ¨context/stateå’Œparametersç›¸åŒçš„æƒ…å†µä¸‹ï¼Œä¸Šé¢ä¸¤ä¸ªå‡½æ•°æ˜¯ç­‰æ•ˆçš„ï¼ŒåŒºåˆ«åœ¨äºAIå·¥å…·éœ€è¦è°ƒç”¨å‡½æ•°*getCurrentTaskInput*æ¥è·å–stateï¼Œå¹¶å¼ºåˆ¶è¦æ±‚name, description, schemaç­‰é™„åŠ ä¿¡æ¯ä»¥ç¡®ä¿AIè¾“å…¥çš„å‚æ•°æ ¼å¼æ­£ç¡®ï¼Œè€ŒAPIå‡½æ•°å°±å¯ä»¥å°†contextçš„ç±»å‹è®¾ç½®ä¸ºanyï¼Œåªè¦ç¨‹åºä¼ å…¥çš„å‚æ•°ç»“æ„æ­£ç¡®ï¼ŒAPIå‡½æ•°å°±ä¸ä¼šå‡ºé”™ï¼Œä½†AIå·¥å…·åœ¨æ²¡æœ‰schemaçš„æƒ…å†µä¸‹ä¼šç›´æ¥æŠ¥é”™ã€‚

#### AIå¯è¯»çš„å‚æ•°
ä¸Šæ–‡æœ‰æè¿‡AIå¯è¯»æ€§çš„é—®é¢˜ï¼Œä½†ç”¨çš„ä¾‹å­æ¯”è¾ƒå’Œè°ï¼Œè¿˜æœ‰ä¸€äº›åŠŸèƒ½çš„å‚æ•°è®¾è®¡ä¼šå¯¼è‡´AIå·¥å…·å’Œå‰ç«¯Hookäº§ç”Ÿè¾ƒå¤§åˆ†æ­§ï¼Œæ¯”å¦‚æ›´æ–°ç½‘ç»œç«¯å£çš„åŠŸèƒ½å‡½æ•°ï¼Œåœ¨å½“å‰Devboxçš„APIæ–‡æ¡£é‡Œï¼Œå¯¹portså‚æ•°çš„æè¿°æ˜¯è¿™æ ·çš„ï¼š

```
ports(å¯é€‰)ï¼šç«¯å£é…ç½®æ•°ç»„
- **åŒ…å«portName**ï¼šæ›´æ–°ç°æœ‰ç«¯å£
- **ä¸åŒ…å«portName**ï¼šåˆ›å»ºæ–°ç«¯å£
- **æœªåŒ…å«çš„ç°æœ‰ç«¯å£**ï¼šå°†è¢«åˆ é™¤
```

è¿™æ„å‘³ç€ç«¯å£çš„åˆ›å»ºã€æ›´æ–°ã€åˆ é™¤è¢«æ•´åˆåˆ°äº†ä¸€ä¸ªç«¯å£ä¸­ï¼Œå‡è®¾ä¸€ä¸ªdevboxæœ‰ä¸‰ä¸ªç«¯å£ï¼š

```tsx title="ç°æœ‰æ•°æ®"
[
  {
    "portName": "a",
    "number": "1"
  },
  {
    "portName": "b",
    "number": "2"
  },
  {
    "portName": "c",
    "number": "3"
  }
]
```

é‚£ä¹ˆå¦‚æœæˆ‘æƒ³åˆ é™¤ç«¯å£a,æ›´æ–°ç«¯å£bçš„ç«¯å£å·ä¸º3000,å¹¶ä¸”æ–°å¢ç«¯å£dï¼Œæ­¤æ—¶éœ€è¦ä¼ é€’çš„å‚æ•°å°±æ˜¯ï¼š

```json title="æ›´æ–°å‚æ•°"
[
  {
    "portName": "b",
    "number": "3000"
  },
  {
    "portName": "c",
  },
  {
    "portName": "d",
    "number": "4"
  }
]
```

è¿™ä¸ªè®¾è®¡åˆç†ï¼Œå°†æ‰€æœ‰æ“ä½œåˆå¹¶åœ¨ä¸€ä¸ªæ¥å£é‡Œå¯ä»¥å‡å°‘è¯·æ±‚æ•°é‡ï¼Œå¦‚æœåˆ›å»ºã€æ›´æ–°ã€åˆ é™¤ä¸‰ä¸ªæ“ä½œåˆ†æ•£åœ¨ä¸‰ä¸ªæ¥å£é‡Œï¼Œé‚£ä¹ˆä¸Šè¿°æ”¹åŠ¨å°±éœ€è¦å‘é€ä¸‰æ¬¡è¯·æ±‚ï¼Œé€ æˆæ›´é«˜å»¶è¿Ÿï¼Œå¯¹AIæ¥è¯´ä¹Ÿéœ€è¦è°ƒç”¨æ›´å¤šæ¬¡å·¥å…·ã€‚

ä½†AIå·¥å…·æ²¿ç”¨è¿™ä¸ªå‚æ•°ç»“æ„ï¼Œé‚£ä¹ˆå³ä½¿AIåªæƒ³æ–°å¢ä¸€ä¸ª3001ç«¯å£ï¼ŒAIä¹Ÿéœ€è¦ç”Ÿæˆå…¶ä½™æ‰€æœ‰ç«¯å£çš„åç§°ä»¥ç¡®ä¿å…¶ä»–ç«¯å£ä¸ä¼šè¢«åˆ é™¤ï¼Œè¿™å°±è¿åäº†å‚æ•°ç®€çŸ­çš„è¦æ±‚ï¼Œè€Œä¸”è¿™ä¸æ˜¯å”¯ä¸€çš„é—®é¢˜ã€‚

ä»¥AIå·¥å…·ä¸ºå‡ºå‘ç‚¹ï¼Œå‚æ•°éœ€è¦ç¬¦åˆä¸¤æ¡è¦æ±‚ï¼š
1. å‚æ•°ç®€çŸ­ï¼Œä¸è¦å¼•å…¥æ— å…³æ•°æ®ï¼›
2. å·¥å…·è°ƒç”¨æ¬¡æ•°å°½å¯èƒ½å°‘ã€‚

ä¸ºäº†ç¬¦åˆç¬¬ä¸€æ¡è¦æ±‚ï¼ŒAIåº”è¯¥æœ‰ä¸‰ä¸ªæ“ä½œç«¯å£çš„å·¥å…·ï¼š
1. åˆ›å»ºï¼šåªä¼ å…¥ç«¯å£å·åˆ—è¡¨ï¼Œå¦‚[1, 2, 3];
2. æ›´æ–°ï¼šåªä¼ å…¥æ—§ç«¯å£å·å’Œæ–°ç«¯å£å·ï¼Œå¦‚`[{1, 2}, {3, 4}]`;
3. åˆ é™¤ï¼šåªä¼ å…¥ç«¯å£å·åˆ—è¡¨ï¼Œå¦‚[1, 2, 3].

ä¸ºäº†ç¬¦åˆç¬¬äºŒæ¡è¦æ±‚ï¼Œè¿™ä¸‰ä¸ªå·¥å…·éœ€è¦åˆå¹¶ï¼Œæ‰€ä»¥åº”è¯¥åªæä¾›ä¸€ä¸ªå·¥å…·ï¼Œå‚æ•°åŒ…å«create, update, deleteä¸‰ä¸ªå­—æ®µï¼Œæ¯ä¸ªå­—æ®µåŒ…å«å¯¹åº”çš„æ•°æ®ç±»å‹ï¼Œè¿™æ—¶å‚æ•°æ˜¯ï¼š

```json title="åˆå¹¶åçš„æ›´æ–°ç«¯å£å‚æ•°"
{
	create: [1, 2, 3],
	update: [{1, 2}, {3, 4}],
	delete: [1, 2, 3]
}
```

è¿™ä¸æ˜¯å®Œæ•´çš„å‚æ•°ï¼Œå› ä¸ºç«¯å£çš„åè®®å’Œå…¬ç½‘è®¿é—®ä¹Ÿæ˜¯å¯ä»¥ä¿®æ”¹çš„ï¼Œå¦‚æœåŠ ä¸Šè¿™äº›å‚æ•°ï¼Œå¤æ‚åº¦è¿˜ä¼šä¸Šå‡ï¼š

```json
{
  "create": [
    { "number": 1, "protocol": "HTTP", "exposesPublicDomain": true },
    { "number": 2, "protocol": "HTTP", "exposesPublicDomain": true },
    { "number": 3, "protocol": "HTTP", "exposesPublicDomain": true }
  ],
  "update": [
    { "oldNumber": 2, "number": 1, "protocol": "HTTP", "exposesPublicDomain": true },
    { "oldNumber": 1, "number": 3, "protocol": "HTTP", "exposesPublicDomain": true }
  ],
  "delete": [
    { "number": 1 },
    { "number": 2 },
    { "number": 3 }
  ]
}
```

åˆ°è¿™ä¸€æ­¥ï¼Œâ€œå‚æ•°ç®€çŸ­â€çš„åŸåˆ™å®é™…ä¸Šå·²ç»ç»´æŒä¸äº†äº†ï¼Œä¸Šè¿°è¿™ç§ä»¥â€AIå¯è¯»â€ä¸ºç›®çš„è®¾è®¡å‡ºçš„å‚æ•°åç¦»äº†åº•å±‚åŠŸèƒ½å‡½æ•°çš„å‚æ•°ç»“æ„ï¼Œä¹Ÿå¢åŠ äº†schemaç»´æŠ¤çš„å·¥ä½œé‡ï¼Œä½†å…¶å®å¹¶æ²¡æœ‰å‰Šå‡å¾ˆå¤šå¤æ‚åº¦ï¼Œä»ç»“æœæ¥çœ‹å¾—ä¸å¿å¤±ï¼Œä¸å¦‚æ²¿ç”¨ç°åœ¨APIå‡½æ•°çš„å‚æ•°ç»“æ„ï¼š

```json title="å›åˆ°åŸç‚¹"
[
  {
    "portName": "b",
    "number": "3000"
  },
  {
    "portName": "c",
    "number": "3"
  },
  {
    "portName": "d",
    "number": "4"
  }
]
```
å…¶å®çœ‹èµ·æ¥ä¹Ÿä¸æ˜¯å¾ˆå¤æ‚ï¼Œä½†åœ¨AIçœ¼ä¸­ï¼Œè¿™ç§å‚æ•°çš„é—®é¢˜åœ¨äºâ€œä¸ç›´è§‚â€ï¼Œå½“å‚æ•°è¢«åˆ†ä¸º*create*, *update*, *delete*æ—¶ï¼Œå³ä½¿ä¸ä¼ å…¥é¢å¤–çš„ä½¿ç”¨è¯´æ˜ï¼ŒAIè¾“å‡ºæ­£ç¡®å‚æ•°çš„æ¦‚ç‡ä¹Ÿå¾ˆé«˜ï¼Œä½†å¯¹äºåŒ…å«éšè—è§„åˆ™çš„å‚æ•°ï¼ˆä¼ å…¥portNameä»£è¡¨æ›´æ–°ï¼Œçœç•¥portNameä»£è¡¨åˆ é™¤ï¼‰è¯¦ç»†çš„ä½¿ç”¨è¯´æ˜å’Œç¤ºä¾‹æ˜¯å¿…é¡»çš„ï¼Œè¿™äº›å¯ä»¥åœ¨å·¥å…·descriptionå’Œæ¨¡å‹ç³»ç»Ÿæç¤ºè¯é‡Œæä¾›ã€‚

è¿™ä¸€èŠ‚çš„ç»“è®ºï¼š**APIå’ŒAIå·¥å…·çš„å‚æ•°è®¾è®¡å†²çªæ—¶ï¼Œè€ƒè™‘è®©AIå·¥å…·é€‚é…APIã€‚ä»ç»éªŒæ¥è¯´ï¼Œä¸€ä¸ªAPIæ¥å£å¦‚æœè‡ªèº«çš„å‚æ•°è®¾è®¡ä¼˜ç§€ï¼Œé‚£ä¹ˆåŒæ ·çš„å‚æ•°æ²¿ç”¨åˆ°AIå·¥å…·ä¸­æ˜¯æ²¡é—®é¢˜çš„ï¼Œå¦‚æœAPIæ¥å£å‚æ•°åŒ…å«éšè—è§„åˆ™ï¼Œé‚£ä¹ˆè½¬æ¢åˆ°AIå·¥å…·æ—¶éœ€è¦é™„åŠ ä½¿ç”¨è¯´æ˜å’Œç¤ºä¾‹**ã€‚

### å·¥å…·ä½¿ç”¨è¯´æ˜
â€œå·¥å…·ä½¿ç”¨è¯´æ˜â€è¿™ä¸ªåè¯æœ‰ç‚¹é•¿ï¼Œä½†æˆ‘æš‚æ—¶ä¹Ÿæ²¡æ‰¾åˆ°æ›´ç®€çŸ­çš„åè¯ï¼Œå…·ä½“æ¥è¯´ï¼Œä½¿ç”¨è¯´æ˜ç”±ä¸‰éƒ¨åˆ†ç»„æˆï¼š
1. ç³»ç»Ÿæç¤ºè¯ä¸­çš„æ–‡æœ¬æè¿°ï¼›
2. å·¥å…·å®šä¹‰ä¸­çš„æ–‡æœ¬æè¿°ï¼›
3. å·¥å…·å®šä¹‰ä¸­çš„å‚æ•°schema.

ä»¥ä¸‹é¢è¿™ä¸ªå·¥å…·ä¸ºä¾‹ï¼š
```tsx
const welcome = tool(
	({ joke }, config) => {
		const currentTaskInput = getCurrentTaskInput();
		return `Welcome the user to the new agent. \n\n Joke: ${joke} \n\n State: ${JSON.stringify(config.context)} \n\n Current Task Input: ${JSON.stringify(currentTaskInput)}`;
	},
	{
		name: "welcome",
		description: "Welcome the user with a joke.", // å·¥å…·å®šä¹‰ä¸­çš„æ–‡æœ¬æè¿°
		schema: z.object({
			joke: z.string().describe("The joke to welcome the user with"),
		}), // å·¥å…·å®šä¹‰ä¸­çš„å‚æ•°schema
	},
);
```
å¯ä»¥çœ‹åˆ°å·¥å…·çš„æœ€åä¸€ä¸ªå‚æ•°æ˜¯ä¸€ä¸ªåŒ…å«name, descriptionå’Œschemaçš„å¯¹è±¡ï¼Œè¿™ä¸ªå¯¹è±¡å¯¹äºAIæ¥è¯´æ˜¯å®Œå…¨å¯è§çš„ï¼Œä¹Ÿæ˜¯AIå¯¹äºå·¥å…·çš„**å”¯ä¸€è®¤çŸ¥æ¥æº**ï¼ŒAIåœ¨è¿è¡Œä¸­ä¸ä¼šçœ‹åˆ°ä»»ä½•å·¥å…·å†…éƒ¨çš„åº•å±‚é€»è¾‘ï¼Œå¦‚`return â€œWelcome the...â€`è¿™äº›å†…å®¹éƒ½çœ‹ä¸è§ï¼Œå½“AIæ¥æ”¶åˆ°ç”¨æˆ·è¯·æ±‚æ—¶ï¼Œå®ƒä¼šæ£€æŸ¥æ‰€æœ‰å·¥å…·çš„nameå’Œdescriptionå­—æ®µï¼Œåˆ¤æ–­éœ€è¦è°ƒç”¨çš„å·¥å…·æ˜¯å“ªä¸ªï¼Œç„¶åæ ¹æ®schemaç”Ÿæˆå¯¹åº”çš„å‚æ•°ï¼Œå¦‚åœ¨welcomeå·¥å…·é‡Œå£°æ˜äº†ä¸€ä¸ªåä¸ºjokeçš„å­—ç¬¦ä¸²å‚æ•°ï¼Œé‚£ä¹ˆAIå°±ä¼šç”Ÿæˆï¼š
```json
{
	joke: "Why did the developer go broke? Because he used up all his cache"
}
```
è¿™å°±æ˜¯AIåœ¨è°ƒç”¨å·¥å…·æ—¶ä¼šåšçš„ä¸€åˆ‡ï¼Œå·¥å…·çš„å…·ä½“æ‰§è¡Œä»ç„¶æ˜¯ç”±ç¨‹åºè´Ÿè´£çš„ï¼Œå½“ç¨‹åºæ‰§è¡Œå®Œæˆåï¼Œç»“æœï¼ˆåœ¨welcomeå·¥å…·ä¸­ï¼Œç»“æœå°±æ˜¯returnè¿”å›çš„å­—ç¬¦ä¸²ï¼‰ä¼šæ·»åŠ åˆ°Langgraph Stateçš„æ¶ˆæ¯è®°å½•ä¸­ï¼ŒAIå¯ä»¥å†å®Œæ•´è¯»å–ä¸€æ¬¡åŒ…å«å·¥å…·è°ƒç”¨ç»“æœçš„æ¶ˆæ¯æ¥è¿›è¡Œæ€»ç»“ï¼Œä½†è¿™å…¶å®å·²ç»ç®—æ˜¯æ–°ä¸€è½®å¯¹è¯äº†ï¼Œä¸Šä¸€è½®å¯¹è¯åœ¨AIç”Ÿæˆå‚æ•°åå°±ç»“æŸäº†ã€‚

Schemaä¸ä»…å¯ä»¥å£°æ˜å‚æ•°çš„æ•°æ®ç±»å‹ï¼Œä¹Ÿå¯ä»¥é€šè¿‡æ ¼å¼éªŒè¯æ¥ç¡®ä¿AIç”Ÿæˆæ­£ç¡®çš„æ•°æ®ç»“æ„ï¼Œå¸¦æœ‰`joke: z.string()`å£°æ˜çš„å­—æ®µåªä¼šæ˜¯å­—ç¬¦ä¸²ç±»å‹ï¼Œä½†`joke: z.any()`æœ‰å¯èƒ½æ˜¯å­—ç¬¦ä¸²æ•°ç»„ï¼Œå› æ­¤æ˜ç¡®schemaå®šä¹‰æ˜¯ç¡®ä¿AIå·¥å…·æ­£ç¡®è°ƒç”¨çš„åº•çº¿ï¼Œç†è®ºä¸Šz.any()æˆ–è€…typescriptè‡ªå¸¦çš„anyç±»å‹æ˜¯ä¸å…è®¸åœ¨é¡¹ç›®é‡Œä½¿ç”¨çš„ã€‚

~~æˆ‘åœ¨ä»£ç åº“é‡Œç•™äº†ä¸å°‘anyç±»å‹çš„å‚æ•°ï¼Œæ–¹ä¾¿å¤§å®¶çœ‹å®Œæ–‡æ¡£åç”¨ä½œç»ƒä¹ ç´ æã€‚~~

Descriptionå’Œç³»ç»Ÿæç¤ºè¯æ˜¯AIè·å–è®¤çŸ¥çš„ä¸»è¦æ¥æºï¼Œæ¨¡å‹çš„å¤§éƒ¨åˆ†è¡Œä¸ºéƒ½å¯ä»¥é€šè¿‡è¿™ä¸¤ç§æ–‡æœ¬æè¿°æ¥è¿›è¡Œå¼•å¯¼ï¼Œè¿™é‡Œä¸éœ€è¦å¤ªå¤šè¯´æ˜ã€‚


## Query/Mutationå‡½æ•°

åŠŸèƒ½å‡½æ•°åªç”¨äºå®ç°ä¸€ä¸ªåŠŸèƒ½ï¼ˆæŸ¥è¯¢/ä¿®æ”¹ç‰¹å®šæ•°æ®ï¼‰è€Œä¸ä¼šé’ˆå¯¹ä¸Šå±‚åˆ†æ”¯åšä»»ä½•é™„åŠ åŠŸèƒ½çš„ä¼˜åŒ–ï¼Œå¯ä»¥è¯´åŠŸèƒ½å‡½æ•°å”¯ä¸€çš„è®¾è®¡è¦ç‚¹åœ¨äºç¡®ä¿è‡ªèº«å‚æ•°å‹å¥½ã€åŠŸèƒ½ç®€æ´ï¼ŒåŠŸèƒ½å‡½æ•°çš„è§„èŒƒæ˜¯ä»£ç å·¥ç¨‹çš„è§„èŒƒï¼Œä¸æ˜¯å‰ç«¯å‡½æ•°æˆ–AIå·¥å…·çš„è§„èŒƒã€‚

è¿™ç§è®¾è®¡æ„å‘³ç€åŠŸèƒ½å‡½æ•°ä¼šæœ‰æ„æ— è§†ä¸Šå±‚å‡½æ•°çš„éœ€æ±‚ï¼Œæ¯”å¦‚å‰ç«¯æ•°æ®æŸ¥è¯¢å‡½æ•°çš„éœ€æ±‚ï¼š
1. å®šæ—¶åˆ·æ–°æ•°æ®ï¼›
2. æŸ¥è¯¢å¤±è´¥åè‡ªåŠ¨é‡è¯•ï¼›
3. æŠ¥é”™å±•ç¤ºå’Œå¤„ç†é€»è¾‘ã€‚

ä»¥åŠå‰ç«¯æ•°æ®ä¿®æ”¹å‡½æ•°çš„éœ€æ±‚ï¼š
1. ä¿®æ”¹æ•°æ®åè§¦å‘é™„åŠ é€»è¾‘ï¼Œå¦‚æ›´æ”¹devboxåç§°åï¼Œå¹¿æ’­é€šçŸ¥å…¶ä»–ç»„ä»¶æŸ¥è¯¢æœ€æ–°æ•°æ®ï¼›

åŠŸèƒ½å‡½æ•°ä¸ä¼šæä¾›è¿™äº›åŠŸèƒ½ï¼ˆç”šè‡³è¿try...catchä¹Ÿæ²¡æœ‰ï¼‰ï¼Œæ‰€æœ‰å‰ç«¯éœ€è¦çš„é™„åŠ åŠŸèƒ½éœ€è¦åœ¨å‰ç«¯å†…éƒ¨å®ç°ï¼ŒBrainä½¿ç”¨[Tanstack Query(TQ)](https://tanstack.com/query/latest/docs/framework/react/overview) & [TRPC](https://trpc.io/docs)æ¥ç»„ç»‡æ‰€æœ‰åŠŸèƒ½å‡½æ•°ï¼Œè€Œåœ¨TQä¸­ï¼Œå‡½æ•°åˆ†ä¸ºä¸¤ç±»ï¼š

1. Queryï¼šå…·å¤‡å®šæ—¶åˆ·æ–°ã€é”™è¯¯é‡è¯•ç­‰é™„åŠ åŠŸèƒ½çš„æ•°æ®æŸ¥è¯¢å‡½æ•°ï¼ŒAPIå‡½æ•°GET /api/v1/devboxåœ¨å°è£…ä¸ºåŠŸèƒ½å‡½æ•°åï¼Œåœ¨å‰ç«¯é‡Œä¼šè¢«ç»§ç»­å°è£…ä¸ºQueryå‡½æ•°ã€‚
2. Mutationï¼šå…·å¤‡Hookï¼ˆç”Ÿå‘½å‘¨æœŸå‰¯ä½œç”¨ï¼Œæ¯”å¦‚åœ¨æ•°æ®ä¿®æ”¹æˆåŠŸå/å¤±è´¥åè§¦å‘console.logï¼‰ç­‰é™„åŠ åŠŸèƒ½çš„æ•°æ®ä¿®æ”¹å‡½æ•°ï¼ŒAPIå‡½æ•°POST /api/v1/devboxçš„åŠŸèƒ½å‡½æ•°åœ¨å‰ç«¯ä¸­ä¼šè¢«å°è£…ä¸ºMutationå‡½æ•°ã€‚

TQçš„ä½œç”¨æ˜¯é’ˆå¯¹è¿™ä¸¤ç§å‡½æ•°æä¾›é™„åŠ åŠŸèƒ½ï¼Œè€ŒTRPCçš„ä½œç”¨åœ¨äºç”¨ç‰¹å®šçš„ç»“æ„ç»„ç»‡è¿™äº›å‡½æ•°å¹¶æä¾›å®Œå¤‡çš„ç±»å‹å®‰å…¨æ€§ï¼ˆä½†å…¶å®åœ¨å¼€å‘æ—¶æœ‰ç‚¹ç¢äº‹ï¼‰TQä¸­Queryå‡½æ•°çš„ä½¿ç”¨æ–¹å¼å¦‚ä¸‹ï¼š

```tsx
import { useQuery } from '@tanstack/react-query'

const { isPending, isError, data, error } = useQuery({
	queryKey: ['todos'],
	queryFn: fetchTodoList,
})
```

1. useQueryï¼šä»TQä¸­å¯¼å…¥çš„å‡½æ•°ï¼Œç”¨æ¥æ¥æ”¶ç”¨äºæ•°æ®æŸ¥è¯¢çš„åŠŸèƒ½å‡½æ•°ï¼›
2. queryKeyï¼šæ‰‹åŠ¨é™„åŠ ç»™åŠŸèƒ½å‡½æ•°çš„Idï¼Œä½œç”¨å’Œæ•°æ®åº“ä¸­æ¯ä¸ªæ¡ç›®çš„Idç±»ä¼¼ï¼Œç”¨äºæ ‡æ³¨å’ŒæŸ¥è¯¢ç‰¹å®šçš„Queryå‡½æ•°ï¼Œå¦‚æœæœ‰Mutationå‡½æ•°éœ€è¦åˆ·æ–°è¿™ä¸ªQueryå‡½æ•°çš„æ•°æ®ï¼Œå¯ä»¥é€šè¿‡queryKeyæ¥å®šä½ï¼›
3. queryFnï¼šéœ€è¦è½¬æ¢ä¸ºQueryçš„åŠŸèƒ½å‡½æ•°ï¼›
4. isPending, isError, data, errorï¼šuseQueryè¿”å›çš„å¯¹è±¡ä¸­åŒ…å«äº†æ‰€æœ‰å‰ç«¯æ•°æ®æŸ¥è¯¢å‡½æ•°éœ€è¦çš„ä¿¡æ¯ï¼ŒisPendingè¡¨ç¤ºæ˜¯å¦åœ¨æ‹‰å–æ–°æ•°æ®ï¼ŒisErrorå’Œerroræœ›æ–‡ç”Ÿä¹‰ï¼Œdataçš„æ•°æ®ä¼šå®šæ—¶åˆ·æ–°ï¼ˆæˆ–è€…è¢«mutationæ‰‹åŠ¨é‡ç½®ï¼‰

Mutationå‡½æ•°çš„ä½¿ç”¨æ–¹å¼å¦‚ä¸‹ï¼š

```tsx
import { useMutation, useQueryClient } from '@tanstack/react-query'

const queryClient = useQueryClient()

const { isPending, submittedAt, variables, mutate, isError } = useMutation({
  mutationFn: addTodo,
  onMutate: (variables, context) => {
    // A mutation is about to happen!

    // Optionally return a result containing data to use when for example rolling back
    return { id: 1 }
  },
  onError: (error, variables, onMutateResult, context) => {
    // An error happened!
    console.log(`rolling back optimistic update with id ${onMutateResult.id}`)
    toast("Mutation Failed!");
  },
  onSuccess: (data, variables, onMutateResult, context) => {
    // Boom baby!
    queryClient.invalidateQueries({ queryKey: ['todos'] })
  },
  onSettled: (data, error, variables, onMutateResult, context) => {
    // Error or success... doesn't matter!
  },
})
```

1. useMutationï¼šä»TQä¸­å¯¼å…¥çš„å‡½æ•°ï¼Œç”¨æ¥æ¥æ”¶ç”¨äºæ•°æ®ä¿®æ”¹çš„åŠŸèƒ½å‡½æ•°ï¼›
2. mutationFnï¼šéœ€è¦è½¬æ¢ä¸ºMutationçš„åŠŸèƒ½å‡½æ•°ï¼›
3. onMutateï¼šä¿®æ”¹å‰è§¦å‘çš„é€»è¾‘ï¼›
4. onErrorï¼šæŠ¥é”™åè§¦å‘çš„é€»è¾‘ï¼ŒBrainé€šå¸¸ä¼šåœ¨è¿™é‡Œè§¦å‘ä¸€ä¸ªtoastï¼›
5. onSuccessï¼šæˆåŠŸåè§¦å‘çš„é€»è¾‘ï¼Œå¤§éƒ¨åˆ†Mutationéƒ½éœ€è¦åœ¨è¿™é‡Œåˆ·æ–°ç‰¹å®šQueryçš„æ•°æ®ï¼Œæ¯”å¦‚`queryClient.invalidateQueries({ queryKey: ['todos'] })`å°±å¯ä»¥åˆ·æ–°queryKeyä¸º'todos'çš„æ•°æ®ï¼›
6. onSettledï¼šMutationæ‰§è¡Œå®Œæˆï¼ˆæ— è®ºæ˜¯å¦æˆåŠŸï¼‰åè§¦å‘çš„é€»è¾‘ã€‚

Queryå’ŒMutationå¯ä»¥ç›´æ¥åœ¨Reactç»„ä»¶ä¸­è°ƒç”¨ï¼Œä½†ä¸ºäº†é¿å…Query/Mutationå¼•å…¥å¤ªå¤šä»£ç å’Œé‡å¤é€»è¾‘ï¼ŒBrainé‡Œä¼šè¿›ä¸€æ­¥å°è£…å®ƒä»¬ä¸ºReact Hook.

```tsx title="Query Hook"
"use client";

import type { CustomResourceTarget } from "@sealos-brain/k8s/shared/models";
import { useQuery } from "@tanstack/react-query";
import { useTRPCClients } from "@/hooks/trpc/use-trpc-clients";

export const useDevboxObject = (target: CustomResourceTarget) => {
	const { devbox } = useTRPCClients();

	const query = useQuery(devbox.get.queryOptions(target));

	return {
		data: query.data,
		isLoading: query.isLoading,
		isError: query.isError,
		error: query.error,
	};
};

```

```tsx title="è°ƒç”¨Query Hookçš„ç»„ä»¶"
export function DevboxNodeBlock({ data }: DevboxNodeBlockProps) {
	const { id, target } = data;
	const { data: object } = useDevboxObject(target);
}
```

`const { data: object } = useDevboxObject(target); `å¯ä»¥åœ¨æ‰€æœ‰å‰ç«¯ç»„ä»¶ä¸­è°ƒç”¨ä¸”å…±äº«é€»è¾‘å’Œæ•°æ®ï¼Œå‡å°‘äº†å„ä¸ªç»„ä»¶çš„ä»£ç é‡ï¼Œä¹Ÿæœ‰åŠ©äºåŒæ­¥åç»­çš„æ”¹åŠ¨ã€‚

Mutation Hookä¹Ÿæ˜¯ä¸€æ ·çš„ç»“æ„ï¼Œä¸è¿‡æ¶‰åŠåˆ°Mutationè°ƒç”¨å’Œç”Ÿå‘½å‘¨æœŸHookï¼ˆå’ŒReact Hookä¸åŒï¼ŒMutationå‡½æ•°çš„Hookåªä½œç”¨äºåŠŸèƒ½å‡½æ•°è‡ªå·±çš„ç”Ÿå‘½å‘¨æœŸï¼Œè™½ç„¶éƒ½å«Hookï¼Œä½†åˆ«æ··æ·†äº†ï¼‰çš„åœ°æ–¹åœ¨å¼€å‘æ–‡æ¡£é‡Œç”¨å®é™…ä»£ç è¯¦ç»†è¯´æ˜æ›´å¥½ï¼Œè¿™é‡Œåªå±•ç¤ºä¸€ä¸‹Mutation Hookçš„æ ·å­ï¼ˆBrainé‡æ„å‰çš„ä»£ç ï¼Œä¸ä»£è¡¨æœ€ç»ˆå“è´¨ï¼‰ã€‚

```tsx title="Mutation Hook"
export const useDevboxUpdate = ({
  onSuccess,
  onError,
}: UseDevboxUpdateOptions = {}) => {
  const { devbox } = useTRPCClients();
  const { invalidateQueries } = useInvalidateQueries();

  const mutation = useMutation({
    ...devbox.update.mutationOptions(),
    onSuccess: (data) => {
      toast.success("Devbox updated successfully!");
      onSuccess?.(data);
      const target = convertResourceTypeToTarget("devbox", data.name);
      invalidateQueries([
        devbox.get.queryKey(),
        devbox.releases.queryKey(data.name),
      ]);
    },
    onError: (error: any) => {
      console.error("Devbox update error:", error);
      toast.error(error.message || "Failed to update devbox");
      onError?.(error);
    },
  });

  const updateDevbox = async (data: DevboxUpdateFormData) => {
    await mutation.mutateAsync(data);
  };

  return {
    updateDevbox,
    isLoading: mutation.isPending,
  };
};
```

Hookæ˜¯ç»„ç»‡Query/Mutationçš„ç¬¬ä¸€ä¸ªæ–¹æ³•ï¼Œç¬¬äºŒä¸ªæ˜¯[TRPC](https://trpc.io/docs)ï¼Œç”±å…­ä¸ªéƒ¨ä»¶ç»„æˆï¼š

1. contextï¼šé™„åŠ åœ¨æ¯æ¬¡Query/Mutationè°ƒç”¨ä¸­çš„contextä¿¡æ¯ï¼Œæ¯”å¦‚KC.
2. error handlerï¼šé”™è¯¯å¤„ç†é€»è¾‘ã€‚
3. routerï¼šæ”¶å½•æ‰€æœ‰Query/Mutationå‡½æ•°å¹¶è§„èŒƒå®ƒä»¬çš„è¾“å…¥è¾“å‡ºçš„ç±»å‹ã€‚
4. routeï¼šåœ¨æœåŠ¡å™¨ç«¯ä¼ é€’è¯·æ±‚ã€‚
5. configï¼šåœ¨å®¢æˆ·ç«¯ä¼ å…¥contextä¿¡æ¯ã€è®¾ç½®è¯·æ±‚åœ°å€ã€‚
6. clientï¼šåœ¨å®¢æˆ·ç«¯ç»„ä»¶å†…éƒ¨æä¾›ç›´æ¥è®¿é—®routerçš„æ–¹æ³•ã€‚

æˆ‘çŸ¥é“ä½ åœ¨æƒ³ä»€ä¹ˆï¼Œä½†Brainå¼•å…¥é¢å¤–çš„å¤æ‚åº¦æ˜¯æœ‰ç†ç”±çš„ï¼Œåœ¨éœ€è¦åŒæ—¶å¯¹æ¥k8s, devbox,æ•°æ®åº“,launchpad,langgraph,å¯¹è±¡å­˜å‚¨,ai proxy...ä»¥åŠæœªæ¥ä¸€ç³»åˆ—å…¶ä»–APIå‡½æ•°çš„æƒ…å†µä¸‹ï¼Œç”¨routeræ¥åˆ’åˆ†ä¸åŒå½’å±çš„APIï¼Œç”¨contextæ¥å®šä¹‰ä¸åŒAPIéœ€è¦çš„contextï¼ŒåŒæ—¶å€ŸåŠ©Zodæ¥ç¡®ä¿æ‰€æœ‰APIå‡½æ•°ç±»å‹å®‰å…¨æ˜¯é™ä½å¤æ‚åº¦çš„æœ€ä½³é€‰æ‹©ï¼Œæ²¡äººä¼šæƒ³æ¥æ‰‹50ä¸ªåˆ†æ•£åœ¨ä¸åŒæ–‡ä»¶å¤¹é‡Œå……æ–¥ç€å„ç§ç±»å‹å†²çªå’Œä¸è§„èŒƒå‘½åçš„ä¸åŒåº”ç”¨çš„APIçš„ï¼Œå¯¹å§ğŸ˜Š

TRPCçš„ä¸åŒéƒ¨ä»¶å­˜æ”¾åœ¨é¡¹ç›®çš„ç‰¹å®šç›®å½•ä¸­ï¼š
1. context, error, routerï¼š*.trpc.tsï¼Œå¦‚devbox.trpc.ts, cluster.trpc.tsï¼ˆæ•°æ®åº“åœ¨brainé‡Œç”¨clusterè¡¨ç¤ºï¼‰æ‰€æœ‰trpc.tséƒ½å­˜æ”¾åœ¨apps/frontend/src/trpc/routersä¸‹
2. routeï¼šroute.tsï¼Œä¸åŒåº”ç”¨çš„routeç”¨åŒä¸€ä¸ªåå­—ä½†æ˜¯æ”¾åœ¨ä¸åŒæ–‡ä»¶å¤¹ä¸­ï¼Œå¦‚devboxçš„routeåœ¨apps/frontend/src/app/(frontend)/api/trpc/devbox/[trpc]/route.tsé‡Œã€‚
3. configï¼Œclientï¼šapps/frontend/src/configs/query-trpc.config.tsxæ–‡ä»¶é‡Œä¼šåŒæ—¶å¯¼å…¥æ‰€æœ‰åº”ç”¨çš„routerï¼Œç„¶ååˆ›å»ºclientå’Œconfig.

ä¸ºåº”ç”¨æ­å»ºTRPCæœ‰ä¸€ä¸ªå›ºå®šæµç¨‹ï¼šåŠŸèƒ½å‡½æ•° -> *.trpc.ts -> route.ts -> config & client -> hookï¼Œæœ€åè¿™ä¸ªhookå°±æ˜¯ä¹‹å‰å°è£…äº†Query/Mutationçš„hook.

```tsx title="æœªå¼•å…¥trpcçš„hook"
"use client";

import type { CustomResourceTarget } from "@sealos-brain/k8s/shared/models";
import { useQuery } from "@tanstack/react-query";
import { getDevboxObject } from "@sealos-brain/sealos/devbox/api";

export const useDevboxObject = (target: CustomResourceTarget) => {
	const query = useQuery({
		queryKey: ['devbox'],
		queryFn: getDevboxObject,
	})
	
	return {
		data: query.data,
		isLoading: query.isLoading,
		isError: query.isError,
		error: query.error,
	};
};
```

```tsx title="å¼•å…¥trpcçš„hook"
"use client";

import type { CustomResourceTarget } from "@sealos-brain/k8s/shared/models";
import { useQuery } from "@tanstack/react-query";
import { useTRPCClients } from "@/hooks/trpc/use-trpc-clients";

export const useDevboxObject = (target: CustomResourceTarget) => {
	const { devbox } = useTRPCClients();

	const query = useQuery(devbox.get.queryOptions(target));

	return {
		data: query.data,
		isLoading: query.isLoading,
		isError: query.isError,
		error: query.error,
	};
};
```

useQueryé‡Œçš„queryKeyä¸å†æ˜¯ç¡¬ç¼–ç çš„å­—ç¬¦ä¸²ï¼Œè€Œæ˜¯ç”±trpc clientè‡ªåŠ¨ç”Ÿæˆå¹¶æä¾›ï¼Œä¸å¦¨æƒ³è±¡ä¸€ä¸‹é¡¹ç›®é‡ŒåŒæ—¶æœ‰42ä¸ªç¡¬ç¼–ç queryKeyçš„Queryï¼Œè€Œä½ éœ€è¦åœ¨æ¯æ¬¡mutationå®Œæˆåå‡­è®°å¿†å¡«å…¥éœ€è¦è¢«åˆ·æ–°çš„queryKeyï¼Œè¿™æ˜¯Brainé‡æ„çš„ä¸€ä¸ªåŸå› ã€‚

## Hook
Hookçš„æ ¸å¿ƒç†å¿µåœ¨äºâ€œå°è£…â€ï¼Œè¿™ä¸ªç†å¿µçš„åº”ç”¨åœºæ™¯å¾ˆå®½æ³›ï¼Œè¿‡äºå†—é•¿çš„Queryå‡½æ•°ä½“å¯ä»¥å°è£…ï¼Œéœ€è¦å¤ç”¨çš„é€»è¾‘ä¹Ÿå¯ä»¥å°è£…ï¼Œç”¨Brainé‡Œå°†é¡¹ç›®èµ„æºè½¬åŒ–ä¸ºèŠ‚ç‚¹çš„hookä¸¾ä¾‹:

```tsx
export const useFlow = (instance: CustomResourceTarget) => {
	const { data: resources } = useInstanceResources(instance);

	const { data: objects, isLoading: isLoadingObjects } = useResourceObjects(
		resources || [],
	);

	const { nodes, edges } = useMemo(() => {
		if (!objects || isLoadingObjects) return { nodes: [], edges: [] };

		const baseNodes = convertObjectsToNodes(objects);

		const reliances = inferObjectsReliances(objects);

		const baseEdges = convertReliancesToEdges(reliances, objects);

		const { nodes: networkNodes, edges: networkEdges } =
			deriveNetworkNodesAndEdges(objects);

		const groupedNodes = createDevGroup([...baseNodes, ...networkNodes]);

		const allEdges = [...baseEdges, ...networkEdges];

		const layoutedNodes = applyLayout(groupedNodes, allEdges);

		return { nodes: layoutedNodes, edges: allEdges };
	}, [objects, isLoadingObjects]);

	// console.log("useFlowNodes", { nodes, edges });

	return { nodes, edges };
};
```

è¿™ä¸ªhookåŒæ—¶è´Ÿè´£è·å–èµ„æºã€è½¬æ¢èµ„æºæ ¼å¼ã€æ ¹æ®èµ„æºç”ŸæˆèŠ‚ç‚¹å’Œè¿çº¿ã€è‡ªåŠ¨å¸ƒå±€ç­‰æ‰€æœ‰å±•ç¤ºèŠ‚ç‚¹å‰éœ€è¦æ‰§è¡Œçš„ç¯èŠ‚ï¼Œå‰ç«¯åœ¨è°ƒç”¨è¿™ä¸ªå‡½æ•°æ—¶ï¼Œåªéœ€è¦`const { nodes, edges } = useFlow(instance); `å°±èƒ½ä»é¡¹ç›®åç§°æ‹¿åˆ°æ‰€æœ‰èŠ‚ç‚¹ã€‚

è¿™é‡Œè¿›è¡Œäº†ä¸¤å±‚å°è£…ï¼Œhookæ˜¯ä¸€å±‚ï¼Œhookä¸­è°ƒç”¨çš„å‡½æ•°æ˜¯ç¬¬äºŒå±‚ï¼Œå¦‚æœä¸åšè¿™äº›å°è£…ï¼Œpage.tsxé‡Œçš„ä»£ç ä¼šè¶…è¿‡ä¸€åƒè¡Œï¼Œè€Œä¸”ä¸å¯é¿å…çš„ä¼šå‡ºç°æ— å…³åŠŸèƒ½ç›¸äº’ä¾èµ–çš„æƒ…å†µå¯¼è‡´å¼€å‘éš¾åº¦æé«˜ï¼Œå°è£…çš„è¿‡ç¨‹ä¹Ÿæ˜¯æ¢³ç†ä¸åŒåŠŸèƒ½ä¾èµ–å…³ç³»çš„è¿‡ç¨‹ã€‚

ç†æƒ³æƒ…å†µä¸‹Brainé‡Œæ¯ä¸ªæ–‡ä»¶çš„ä»£ç åº”è¯¥æ§åˆ¶åœ¨200è¡Œä»¥å†…ï¼Œä¸€äº›ç‰¹æ®Šæ–‡ä»¶ï¼ˆæ¯”å¦‚X.utils.tsï¼Œæä¾›é€šç”¨åŠŸèƒ½ï¼‰å¯ä»¥é•¿ä¸€äº›ï¼Œä½†ä¹Ÿä¸åº”è¶…è¿‡300è¡Œï¼Œæ–‡ä»¶å¤ªé•¿çš„æ—¶å€™è®°å¾—è€ƒè™‘ç”¨hookæˆ–å‡½æ•°æ¥å°è£…ã€‚

éœ€è¦æ³¨æ„çš„æ˜¯Hookå’Œå‡½æ•°æ˜¯ä¸åŒçš„å°è£…æ–¹å¼ï¼Œå‚è€ƒä¸‹é¢ä¸¤ä¸ªæ–‡ä»¶ï¼š

```tsx title="Hookå°è£…"
export const useFlow = (instance: CustomResourceTarget) => {
	const { data: resources } = useInstanceResources(instance);

	const { data: objects, isLoading: isLoadingObjects } = useResourceObjects(
		resources || [],
	);

	const { nodes, edges } = useMemo(() => {
		if (!objects || isLoadingObjects) return { nodes: [], edges: [] };

		const baseNodes = convertObjectsToNodes(objects);

		const reliances = inferObjectsReliances(objects);

		const baseEdges = convertReliancesToEdges(reliances, objects);

		const { nodes: networkNodes, edges: networkEdges } =
			deriveNetworkNodesAndEdges(objects);

		const groupedNodes = createDevGroup([...baseNodes, ...networkNodes]);

		const allEdges = [...baseEdges, ...networkEdges];

		const layoutedNodes = applyLayout(groupedNodes, allEdges);

		return { nodes: layoutedNodes, edges: allEdges };
	}, [objects, isLoadingObjects]);

	// console.log("useFlowNodes", { nodes, edges });

	return { nodes, edges };
};
```

```tsx title="å‡½æ•°å°è£…"
export const convertObjectsToNodes = (objects: ResourceObject[]): Node[] =>
	_.map(objects, ({ name, resourceType }) => ({
		id: `${resourceType.toLowerCase()}-${name}`,
		type: ["deployment", "statefulset"].includes(resourceType.toLowerCase())
			? "launchpad"
			: resourceType.toLowerCase(),
		position: { x: 0, y: 0 },
		data: {
			id: `${resourceType.toLowerCase()}-${name}`,
			target: resourceParser.toTarget({ resourceType, name }),
		},
	}));
```

useFlowæ˜¯Hookï¼ˆåç§°å¼€å¤´ä¸ºâ€™useâ€™ä»£è¡¨Hookï¼‰è€ŒconvertObjectsToNodesæ˜¯å‡½æ•°ï¼Œå®ƒä»¬ä¹‹é—´çš„åŒºåˆ«åœ¨äºuseFlowé€šè¿‡å¦ä¸€ä¸ªhook `useInstanceResources ` å’ŒReact contextäº§ç”Ÿäº†ä¾èµ–ï¼ŒuseFlowå› æ­¤åªèƒ½åœ¨Reactå‰ç«¯ç»„ä»¶é‡Œæ‰§è¡Œï¼Œè€ŒconvertObjectsToNodesåªè¦è¾“å…¥çš„å‚æ•°ç¬¦åˆç±»å‹è¦æ±‚å°±å¯ä»¥æ‰§è¡Œã€‚

ç®€å•æ¥è¯´ï¼Œä¸€ä¸ªå‡½æ•°æˆä¸ºHookçš„æ ‡å‡†æ˜¯ï¼š
1. å®ƒä¾èµ–äº†React Contextç›¸å…³çš„hookï¼Œå¦‚useState, useContext, useEffect...æ‰€æœ‰Reactæä¾›çš„Hook(â€˜useâ€™å¼€å¤´çš„å‡½æ•°)ï¼Œåªè¦å‡ºç°åœ¨ä¸€ä¸ªå‡½æ•°ä¸­ï¼Œéƒ½ä¼šå°†å®ƒè½¬å˜ä¸ºHookï¼Œæ„å‘³ç€è¯¥å‡½æ•°æ— æ³•è„±ç¦»Reactæ‰§è¡Œï¼›
2. åŸºäºç¬¬ä¸€ä¸ªæ ‡å‡†ï¼Œæ‰€æœ‰ä¾èµ–äº†ç¬¬ä¸‰æ–¹åº“æä¾›çš„ä»¥â€™useâ€™å¼€å¤´çš„Hookçš„å‡½æ•°ï¼Œä¹Ÿä¼šè¢«è½¬å˜ä¸ºHookï¼Œæ¯”å¦‚TQæä¾›çš„useQueryï¼Œè™½ç„¶ä¸æ˜¯Reactå®˜æ–¹æä¾›ï¼Œä½†é€šè¿‡åç§°å¯ä»¥åˆ¤æ–­å®ƒå†…éƒ¨ä¾èµ–äº†Reactï¼Œå› æ­¤è°ƒç”¨useQueryçš„å‡½æ•°ä¹Ÿä¼šè½¬å˜ä¸ºHook.

ç›¸æ¯”äºå‡½æ•°ï¼ŒHookå¯ä»¥è‡ªç”±è®¿é—®å’Œä¿®æ”¹Reactçš„contextä¿¡æ¯ï¼Œè€Œä¸éœ€è¦ä»å¤–éƒ¨è·å–contextï¼ŒHookåªèƒ½åœ¨å‰ç«¯ç»„ä»¶å†…å¤ç”¨ï¼Œè€Œå‡½æ•°å¯ä»¥åœ¨æ‰€æœ‰åœºæ™¯é‡Œå¤ç”¨ã€‚

å¼€å‘æ—¶æ³¨æ„ä¸è¦æ··æ·†Hookå’Œå‡½æ•°ï¼Œè™½ç„¶ä¸¤è€…æ€§è´¨ä¸åŒï¼Œä½†å³ä½¿ä¸å°å¿ƒæŠŠä¸€ä¸ªHookå‘½åä¸ºâ€™getDevboxObjectâ€™ï¼ˆæ­£ç¡®åç§°æ˜¯useDevboxObjectï¼‰ç¼–è¾‘å™¨ä¹Ÿä¸ä¼šæé†’ä½ æ”¹åï¼Œæ¢å¥è¯è¯´ï¼ŒHookçš„å‘½åå®Œå…¨ç”±å¼€å‘è€…è‡ªå·±å†³å®šï¼Œå› æ­¤å¼€å‘è€…çš„æ„è¯†æ˜¯Hookå‘½åè§„èŒƒçš„å”¯ä¸€ä¿éšœï¼ˆæŠŠHookç”¨é”™åœ°æ–¹åå‡ºç°çš„æŠ¥é”™åº”è¯¥ä¹Ÿç®—ï¼‰




